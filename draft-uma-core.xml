<?xml version="1.0" encoding="US-ASCII"?>
<!DOCTYPE rfc PUBLIC "-//IETF//DTD RFC 2629//EN"
"http://xml.resource.org/authoring/rfc2629.dtd" [
<!ENTITY RFC2119 PUBLIC "" "http://xml.resource.org/public/rfc/bibxml/reference.RFC.2119.xml">
<!ENTITY RFC2617 PUBLIC "" "http://xml.resource.org/public/rfc/bibxml/reference.RFC.2617.xml">
<!ENTITY UMA PUBLIC "" "http://kantarainitiative.org/confluence/display/uma/Home">
<!ENTITY UMAreqs PUBLIC "" "http://kantarainitiative.org/confluence/display/uma/UMA+Requirements">
<!ENTITY RFC3552 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.3552.xml">
<!ENTITY RFC4627 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.4627.xml">
]>
<rfc category="std" docName="draft-uma-core-v1-00-Rev9" ipr="trust200902">
  <?xml-stylesheet type='text/xsl' href='rfc2629.xslt' ?>

  <?rfc toc='yes' ?>

  <?rfc tocdepth='3' ?>

  <?rfc symrefs='yes' ?>

  <?rfc sortrefs='yes' ?>

  <?rfc compact='yes' ?>

  <?rfc subcompact='no' ?>

  <?rfc strict='yes' ?>

  <front>
    <title abbrev="UMA Core Protocol">User-Managed Access (UMA) Core
    Protocol</title>

    <author fullname="Thomas Hardjono" initials="T" role="editor"
            surname="Hardjono">
      <organization>MIT</organization>

      <address>
        <email>hardjono@mit.edu</email>
      </address>
    </author>

    <author fullname="Christian Scholz" initials="C" surname="Scholz">
      <organization>COM.lounge GmbH</organization>

      <address>
        <email>cs@comlounge.net</email>

        <uri>http://comlounge.net</uri>
      </address>
    </author>

    <author fullname="Paul Bryan" initials="P" surname="Bryan">
      <organization>?</organization>

      <address>
        <email>email@pbryan.net</email>

        <uri>http://pbryan.net</uri>
      </address>
    </author>

    <author fullname="Maciej Machulak" initials="M" surname="Machulak">
      <organization>Newcastle University</organization>

      <address>
        <email>m.p.machulak@ncl.ac.uk</email>

        <uri>http://ncl.ac.uk/</uri>
      </address>
    </author>

    <author fullname="Eve Maler" initials="E" surname="Maler">
      <organization>XMLgrrl.com</organization>

      <address>
        <email>eve@xmlgrrl.com</email>

        <uri>http://www.xmlgrrl.com/</uri>
      </address>
    </author>

    <date day="13" month="June" year="2011" />

    <abstract>
      <t>This specification defines the User-Managed Access (UMA) core
      protocol. This protocol provides a method for users to control access to
      their protected resources, residing on any number of host sites, through
      an authorization manager that makes access decisions based on user
      policy.</t>

      <t>This document is a product of the User-Managed Access Work Group of
      the Kantara Initiative. It is currently under active development. It has
      not yet been submitted to the IETF. The User-Managed Access Work Group
      operates under Kantara IPR Policy - Option Patent and Copyright:
      Reciprocal Royalty Free with Opt-Out to Reasonable And Non
      discriminatory (RAND) and the publication of this document is governed
      by the policies outlined in this option.</t>
    </abstract>
  </front>

  <middle>
    <section title="Introduction">
      <t>The User-Managed Access (UMA) core protocol provides a method based
      on <xref target="OAuth2"></xref> (currently draft 16) for users to
      control access to their protected resources, residing on any number of
      host sites, through a single authorization manager (AM) that makes
      access decisions based on user policy.</t>

      <t>For example, a web user (authorizing user) can authorize a web app
      (requester) to gain one-time or ongoing access to a resource containing
      his home address stored at a "personal data store" service (host), by
      telling the host to act on access decisions made by his authorization
      decision-making service (authorization manager or AM). The requesting
      party might be an e-commerce company whose site is acting on behalf of
      the user himself to assist him/her in arranging for shipping a purchased
      item, or it might be his friend who is using an online address book
      service to collect addresses, or it might be a survey company that uses
      an online service to compile population demographics.</t>

      <t>In enterprise settings, application access management often involves
      letting back-office applications serve only as policy enforcement points
      (PEPs), depending entirely on access decisions coming from a central
      policy decision point (PDP) to govern the access they give to
      requesters. This separation eases auditing and allows policy
      administration to scale in several dimensions. UMA makes use of a
      separation similar to this, letting the authorizing user serve as a
      policy administrator crafting authorization strategies on his or her own
      behalf.</t>

      <t>The UMA protocol profiles and extends <xref target="OAuth2"></xref>.
      An AM serves as an enhanced OAuth authorization server; a host serves as
      an enhanced resource server; and a requester serves as an enhanced
      client, acquiring an access token and the requisite authorization to
      access a protected resource at the host.</t>

      <t>UMA also defines an interoperable protection API between the AM and
      host, allowing them to reside in separate domains and allowing the host
      to establish mutual trust with an AM on behalf of a particular user.
      This API is itself OAuth-protected. Thus, the overall UMA flow has a
      second embedded OAuth-based interaction within it governing the host-AM
      relationship.</t>

      <t>UMA has the following three broad phases: <list style="symbols">
          <t>Phase 1: Protect a resource: This phase involves only the
          authorizing user, host, and AM. The authorizing user introduces a
          Host to an AM, the host obtains a host access token to use at the
          AM's protection interface, and the host tells the AM the sets of
          resources which it seeks to be protected . Phase 1 assumes that the
          user also instructs the AM what policies to attach to the registered
          resource sets, but this activity is out of band for UMA. This phase
          has no analogy with OAuth. It is described in <xref
          target="protecting-a-resource"></xref>.</t>

          <t>Phase 2: Get authorization: This phase involves a requester for
          the first time, along with the host and AM, and it may or may not
          involve synchronous involvement by the authorizing user. This phase
          is dominated by a loop of activity in which the requester approaches
          the host seeking access, is sent to obtain an access token from the
          AM if it does not have one, and then must demonstrate to the AM that
          it satisfies the user's authorization policy governing the
          sought-for resource and scope of access if the host discovers that
          it does not have the requisite authorization. This phase is
          analogous to OAuth's "get a token" phase, though it is more
          complex.</t>

          <t>Phase 3: Access a resource: This phase involves the requester
          successfully wielding an access token that has sufficient
          authorization associated with it at the host to gain access to the
          desired resource. This phase is analogous to OAuth's "use a token"
          phase. Phases 2 and 3 together are described in <xref
          target="getting-authz-accessing-resource"></xref>.</t>
        </list></t>

      <section title="Notational Conventions">
        <t>The key words 'MUST', 'MUST NOT', 'REQUIRED', 'SHALL', 'SHALL NOT',
        'SHOULD', 'SHOULD NOT', 'RECOMMENDED', 'MAY', and 'OPTIONAL' in this
        document are to be interpreted as described in <xref
        target="RFC2119"></xref>.</t>

        <t>This document uses the Augmented Backus-Naur Form (ABNF) notation
        of <xref target="ID-ietf-httpbis-p1-messaging"></xref>. Additionally,
        the realm and auth-param rules are included from <xref
        target="RFC2617"></xref>.</t>

        <t>Unless otherwise noted, all the protocol parameter names and values
        are case sensitive.</t>
      </section>

      <section title="Terminology">
        <t><list hangIndent="6" style="hanging">
            <t hangText="authorizing user"><vspace />An UMA-defined variant of
            an OAuth resource owner; a web user who configures an
            authorization manager with policies that control how it makes
            access decisions when a requester attempts to access a protected
            resource at a host.</t>

            <t hangText="authorization manager (AM)"><vspace />An UMA-defined
            variant of an OAuth authorization server that carries out an
            authorizing user's policies governing access to a protected
            resource.</t>

            <t hangText="protected resource"><vspace />An access-restricted
            resource at a host.</t>

            <t hangText="host"><vspace />An UMA-defined variant of an OAuth
            resource server that enforces access to the protected resources it
            hosts, as decided by an authorization manager.</t>

            <t hangText="host access token"><vspace />An access token
            representing the authorizing user's consent for a host to trust a
            particular authorization manager for access decisions about
            resources hosted there.</t>

            <t hangText="claim"><vspace />A statement of the value or values
            of one or more identity attributes of a requesting party. Claims
            are conveyed by a requester on behalf of a requesting party to an
            authorization manager in an attempt to satisfy an authorizing
            user's policy.</t>

            <t hangText="requester"><vspace />An UMA-defined variant of an
            OAuth client that seeks access to a protected resource.</t>

            <t hangText="requester access token"><vspace />An access token
            that can be associated with the authorizing user's consent for a
            requester's access to particular resources at a host.</t>

            <t hangText="requesting party"><vspace />A web user, or a
            corporation or other legal person, that uses a requester to seek
            access to a protected resource.</t>

            <t hangText="resource set description"><vspace />A JSON-formatted
            data structure that represents a set of one or more resources to
            be AM-protected and maps possible scopes to them.</t>

            <t hangText="scope description">A JSON-formatted data structure
            that represents a scope of access on a particular resource
            set.</t>

            <t hangText="token status description">A JSON-formatted data
            structure that represents the currently authorized scopes
            associated with a requester access token.</t>
          </list></t>
      </section>
    </section>

    <!-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -->

    <section anchor="getting-authz-accessing-resource"
             title="Getting Authorization and Accessing a Resource">
      <t>The main purpose of UMA is to orchestrate and control requesting
      parties' access to a user's protected resources at a host, under
      conditions dictated by that user. Thus, the core interaction in UMA
      involves a requester approaching a host and attempting the kind of
      access to a resource there that it seeks.</t>

      <t>Five pairwise interactions characterize the authorization and access
      process. The main interaction is between a requester and host, at the
      host's protected resource endpoint. The host responds to the requester's
      access request in one of several ways depending on the circumstances of
      the request, either immediately or having first performed one or more
      embedded interactions with the AM. Depending on the nature of the host's
      response to an failed access attempt, the requester itself engages in
      embedded interactions with the AM before re-attempting access. The
      pairwise interactions can be summarized as follows:<list style="numbers">
          <t>Requester-host: Attempt access at protected resource. This is the
          master interaction. The host's response, and usage of other embedded
          interactions, varies depending on whether the requester presents a
          token, whether the token is valid, and whether the token is
          associated with a scope that allows for the type of access
          sought.</t>

          <t>Requester-AM: Request an access token. Precondition:<list
              style="symbols">
              <t>The host informed the requester which AM to get an access
              token from in its interaction #1 response.</t>
            </list></t>

          <t>Host-AM: Validate requester's presented access token.
          Precondition:<list style="symbols">
              <t>The requester presented an access token in its interaction 1
              request.</t>
            </list></t>

          <t>Host-AM: Register a requested scope on the requester's behalf.
          Preconditions:<list style="symbols">
              <t>The requester presented a valid access token its interaction
              #1 request.</t>

              <t>The token status returned did not include a currently
              authorized scope that covers the type of access attempted.</t>
            </list></t>

          <t>Requester-AM: Request authorization for scoped access. The
          requester may need to provide claims to prove suitability for
          authorization. Preconditions:<list style="symbols">
              <t>The host registered a scope with the AM on the requester's
              behalf in interaction #4.</t>

              <t>The host gave the requester a requested-scope ticket in its
              interaction #1 response.</t>
            </list></t>
        </list></t>

      <t>This process extends OAuth in several notable ways:<list
          style="symbols">
          <t>The requester's access token issued in interaction #2, in the
          absence of interaction #5, signifies only a binding of this
          requester, the requesting party on whose behalf it is acting, this
          host, and this AM, to be reused for all resources and all scopes of
          access that might be sought at this host protected by this AM.</t>

          <t>Any authorizing-user consent required by policy is gathered in
          interaction #5, rather than at the time of token issuance.</t>

          <t>The process of seeking authorization does not just rely on the
          requester's ability to authenticate as the (or a) resource owner,
          but admits a wide-ranging set of policy options based on attributes
          of the requesting party. This model could be called claims-based
          authorization.</t>
        </list></t>

      <t>The interactions are described in detail in the following
      sections.</t>

      <section anchor="r-h-attempt-access"
               title="Requester-Host: Attempt Access at Protected Resource">
        <t>This interaction assumes that the host has previously registered
        with an AM one or more resource sets that correspond to the resource
        to which access is being attempted, such that the host considers this
        resource to be protected.</t>

        <t>The requester is typically attempts to access the desired resource
        at the host directly (for example, when a human operator of the
        requester software clicks on a thumbnail representation of the
        resource). The requester is expected to discover, or be provisioned
        with, knowledge of the protected resource and its location out of
        band. Further, the requester is expected to acquire its own knowledge
        about the methods made available by the host for operating on this
        resource (such as viewing it with a GET method, or transforming it
        with some complex API call) and the possible scopes of access.</t>

        <t>The host responds in one of five ways.</t>

        <section title="Requester's request is ambiguous">
          <t>By the nature of the requester's request for access (for example,
          through a URL parameter specifying a username or other identifier),
          the host needs to be able to detect uniquely which one of its users
          has the operative control over access to this resource. Without
          this, the host will be unable to interact with the correct AM using
          the correct host access token in protecting the resource.</t>

          <t>If the requester's request is ambiguous with respect to the
          specific user at the host, the host responds with an "ambiguous-user
          error" message.</t>

          <figure>
            <preamble>For example:</preamble>

            <artwork><![CDATA[TBS]]></artwork>
          </figure>
        </section>

        <section title="Requester presents no access token">
          <t>If the requester does not present any access token with the
          request, the host MUST return an HTTP 400 status code indicating it
          is an "invalid_request" [REF: Section 2.4.1 of OAuth Bearer Token
          draft]. This indicates to the requester one of the following: that
          the request is missing a required parameter, that it includes an
          unsupported parameter or parameter value, that it repeats the same
          parameter, that it uses more than one method for including an access
          token, or that it is otherwise malformed.</t>

          <t>(ISSUE#11: Refer to OAuth processes for getting a token
          "autonomously" here? Currently there is no section for the
          requester-AM token-getting interaction.)</t>

          <figure>
            <preamble>For example:</preamble>

            <artwork><![CDATA[TBS]]></artwork>
          </figure>
        </section>

        <section title="Requester presents an invalid access token">
          <t>If the requester presents an access token with its request, the
          host engages in a token validation interaction with the AM to test
          its validity (see <xref target="h-am-token-validation"></xref>). If
          the AM reports that the token is invalid, the Host SHOULD return an
          HTTP 401 status code indicating it is an "invalid_token" [REF:
          Section 2.4.1 of Oauth Bearer Token draft]. This indicates to the
          requester that the access token provided is expired, revoked,
          malformed, or invalid for other reasons.</t>

          <t>(ISSUE#11 : Refer to OAuth processes for getting a token
          "autonomously" here? Currently there is no section for the
          requester-AM token-getting interaction.)</t>

          <figure>
            <preamble>For example:</preamble>

            <artwork><![CDATA[TBS]]></artwork>
          </figure>
        </section>

        <section anchor="insufficient-scope"
                 title="Requester's token has insufficient scope">
          <t>If the requester presents an access token with its request, the
          host engages in a token validation interaction with the AM to test
          its validity (see <xref target="h-am-token-validation"></xref>). If
          the AM reports that the requester's access token is valid, the host
          examines the returned token status. If the token status does not, in
          the host's judgment, contain a scope that applies to the type of
          access attempted by the requester, the Host SHOULD engage in a
          requested-scope registration interaction with the AM (see <xref
          target="h-am-register-scope"></xref>) and respond with the HTTP 403
          (Forbidden) status code indicating that the token has
          "insufficient_scope" [REF: Section 2.4.1 of Oauth Bearer Token
          draft], along with providing the ticket corresponding to the
          just-registered scope.</t>

          <figure>
            <preamble>For example:</preamble>

            <artwork><![CDATA[TBS]]></artwork>
          </figure>
        </section>

        <section title="Requester's token has sufficient scope">
          <t>If the requester presents an access token with its request, the
          host engages in a token validation interaction with the AM to test
          its validity (see <xref target="h-am-token-validation"></xref>). If
          the AM reports that the requester's access token is valid, the host
          examines the returned token status. If the token status, in the
          host's judgment, contains at least one scope that applies to the
          type of access attempted by the requester, the host gives access to
          the desired resource.</t>

          <figure>
            <preamble>For example:</preamble>

            <artwork><![CDATA[TBS]]></artwork>
          </figure>
        </section>
      </section>


      <section anchor="r-am-obtain-token"
        title="Requester-AM: Requester Obtains Access Token">
        
        <t>When a requester is not in posession of a suitable access token
        to access resources at a host, it requests one from the AM.</t>
        
        <t>The requester uses the OAuth2.0 protocol to obtain
        the access token from the AM.  Here the AM takes-on the role
        of the OAuth authorization server, where the AM performs
        the same policy verifications and other related tasks
        as the OAuth authorization server.</t>
        
      </section>
        
        
      <section anchor="h-am-token-validation"
               title="Host-AM: Validate Requester's Presented Access Token">
        <t>On receiving a requester's access token in an access attempt, the
        host asks the AM to validate this token. It gains authorized access to
        the AM's token validation endpoint by presenting its own host access
        token in the request to validate the requester's access token. The
        host access token also allows the host and AM to uniquely identify the
        user they have in common, and therefore allows the AM to look up the
        correct user policies and settings.</t>

        <t>The host's request to the AM is made with a POST containing the
        requester access token and the IP address of the requester's request.
        The host MAY, at its discretion, instead supply the originating IP
        address indicated in the requester's X-Forwarded-For: header value.
        The POST uses the "application/x-www-form-urlencoded" format as
        defined by [W3C.REC-html401-19991224]. The IP address or originating
        IP address is advisory only; the AM MAY ignore it for token validation
        purposes. The host supplies its host access token with the
        request.</t>

        <figure>
          <preamble>Example of a request to the token verification endpoint
          that provides the host access token in the header:</preamble>

          <artwork><![CDATA[
POST /token_verification HTTP/1.1
Host: am.example.com
Authorization: OAuth vF9dft4qmT
Content-Type: application/x-www-form-urlencoded     

token=sbjsbhs(/SSJHBSUSSJHVhjsgvhsgvshgsv&ipaddr=192.168.1.1
       ]]></artwork>
        </figure>

        <section title="AM returns a token invalid response">
          <t>If the the AM finds the requester's access token to be invalid,
          it returns an UMA error message (ISSUE#12: correct? HTTP success?) to
          indicate that the requester's token is invalid.</t>

          <t>AM includes one of the following error codes with the error response:
          (see <xref target="am-error-response"></xref>) and responds with HTTP
          200 status code:

            <list style="hanging">
              <t hangText="invalid_requester_token">The requester's token presented
              by the host to the AM was not valid</t>
            </list></t>

          <figure>
            <preamble>For example:</preamble>

            <artwork><![CDATA[
HTTP/1.1 200 OK
Content-Type: application/json
Cache-Control: no-store
{
   {
      "error":"invalid_requester_token"
   }
}
         ]]></artwork>
          </figure>
        </section>

        <section title="AM returns a token valid response">
          <t>If the the AM finds the requester's access token to be valid, it
          returns an UMA success message (with HTTP success) which supplies
          the token status in an HTTP response using the 200 OK status code
          and containing a JSON document supplying the token status. The token
          status supplies all of the granted scopes and associated resource
          sets that are currently valid for this requester access token (and
          thus for the requesting party on whose behalf it is acting).</t>

          <t>The token status is an object with the name "token_status"
          containing an array of objects with the following parameters:<list
              style="hanging">
              <t hangText="_id">REQUIRED. A string that uniquely identifies
              the resource set, access to which has been granted to this
              requester on behalf of this requesting party. The identifier
              MUST correspond to a resource set that was previously registered
              as protected.</t>

              <t hangText="scopes">REQUIRED. An array referencing one or more
              identifiers of scopes to which access was granted for this
              resource set. Each scope identifier MUST correspond to a scope
              that was registered by this host for the referenced resource
              set.</t>

              <t hangText="exp">REQUIRED.An integer representing the
              expiration time on or after which the scope MUST NOT be accepted
              for authorized access. The processing of the exp parameter
              requires that the current date/time MUST be before the
              expiration date/time listed in the exp claim. Host implementers
              MAY provide for some small leeway, usually no more than a few
              minutes, to account for clock skew.</t>
            </list></t>

          <figure>
            <preamble>Example:</preamble>

            <artwork><![CDATA[
HTTP/1.1 200 OK
Content-Type: application/json
Cache-Control: no-store

{
        "token_status":
           [
              {
                      "_id": "112210f47de98100",
                      "scopes":
                      ["http://photoz.example.com/dev/actions/view",
                        "http://photoz.example.com/dev/actions/all"],
                      "exp": 1300819380
              }
           ]
}    ]]></artwork>
          </figure>

          <t>The host MUST validate if one of the scopes is sufficient for
          requester to access the requested resource in the manner originally
          attempted. If it is, the host gives access in that manner.</t>
        </section>
      </section>

      <section anchor="h-am-register-scope"
               title="Host-AM: Register a Requested Scope">
        <t>If, in the host's judgment, the granted scopes returned by the AM
        from a token validation request are not sufficient for this
        requester's authorized access to the resource, the host registers a
        requested scope with the AM that it believes would be sufficient for
        the type of access sought. The AM returns a requested-scope ticket for
        the host to give to the requester in its response to attempted access
        (see <xref target="insufficient-scope"></xref>).</t>

        <t>The host registers the requested scope using the POST method at the
        AM's registration endpoint, providing its host access token to get
        authorized access to this endpoint. The body of the HTTP request
        message contains a JSON document providing the requester's access
        token and the requested scope. (ISSUE#13: How to structure the body to
        include the scope and also the requester's access token?)</t>

        <t>The requested scope is an object with the name "requested_scope"
        and the following parameters:<list style="hanging">
            <t hangText="_id">REQUIRED. A string that uniquely identifies a
            resource set, access to which this requester is seeking access.
            The identifier MUST correspond to a resource set that was
            previously registered as protected.</t>

            <t hangText="scopes">REQUIRED. An array referencing one or more
            identifiers of scopes to which access is needed for this resource
            set. Each scope identifier MUST correspond to a scope that was
            registered by this host for the referenced resource set.</t>
          </list></t>

        <figure>
          <preamble>For example:</preamble>

          <artwork><![CDATA[TBS]]></artwork>
        </figure>

        <t>On receiving the scope registration request from the Host, the AM
        issues a response message that has one of the possible following
        outputs: (ISSUE#06: Design needs to be completed)<list style="symbols">
            <t>A scope request ticket, which typically has a short life-time,
            and its expiration time.</t>

            <t>Error message indicating a malformed scope registration
            request.</t>
          </list></t>

        <section title="AM returns an error response">
          <t>AM includes one of the following error codes with the error response:
          (see <xref target="am-error-response"></xref>) and responds with HTTP
          400 (Bad Request) status code:

            <list style="hanging">
              <t hangText="invalid_requester_token">The requester's token presented
              by the host to the AM was not valid</t>
              <t hangText="invalid_resource_set_id">The resource set id provided in
              the request was not previously registered at the AM or is invalid
              because of different reason</t>
              <t hangText="invalid_scopes">Scopes provided in the request were not
              previously registered at the AM or are invalid because of different
              reason</t>
            </list></t>

          <figure>
            <preamble>For example:</preamble>

            <artwork><![CDATA[
HTTP/1.1 400 Bad Request
Content-Type: application/json
Cache-Control: no-store
{
   {
      "error":"invalid_resource_set_id"
   }
}
         ]]></artwork>
          </figure>
        </section>
      </section>

      <section anchor="r-am-authz-scope"
               title="Requester-AM: Request Authorization for Scoped Access">
        <t>In this interaction the requester asks the AM to grant
        authorization to add a scope to its access token for use at a
        particular host. It does this at the AM's authorization endpoint by
        supplying the ticket it got from the host that corresponds to the
        desired scope, along with its requester access token. The AM is able
        to use this information to look up the registered requested scope,
        confirm that the correct requester is requesting the scope, mapping
        the requested scope to operative user policies, and demand in turn
        that the requester convey claims to support its request as
        necessary.</t>

        <t>The Requester performs a GET on the access token URL, using the
        standard HTTP "Accept" header to express the acceptable media type(s)
        of any claims-required list. (ISSUE#14: Need to unify the request for
        authorization with the providing of claims, so that this can be a
        single request-response pattern that can loop as required.)</t>

        <t>The AM responds in one of three ways: <list style="symbols">
            <t>If the AM requires no claims from the Requester in order to
            grant authorization based on user policy, it gives success
            response, indicating that the requested scope has been associated
            with the requester's token.</t>

            <t>If the Requester is definitively not authorized according to
            user policy, the AM responds with a failure response and the
            authorization request phase ends.</t>

            <t>If user policy demands more information from the requester, the
            AM responds with a claims-required response containing a
            claims-required list. The list SHOULD use the media type that was
            indicated by the requester as acceptable.</t>
          </list></t>

        <t>If in this step user policy demands more information from the
        Requester and the requester received a claims-required response, then
        the requester needs to satisfy all the claims listed there. Once the
        Requester completes preparing the claims document, it performs a POST
        of that document to the authorization negotiation URL, specifying its
        type in the "Content-Type" header.</t>

        <t>If the content-type is not recognized by the AM, the AM will reject
         the document. 
         (ISSUE#15: If the content-type (of the claims response document)
         is not recognized by the AM, what happens then? 
         Should be an error from the AM.)</t>

        <t>If the AM accepts the claims document submitted by the requester,
        the AM responds with a successful or unsuccessful access token
        response, or with another claims-required response. 
        (ISSUE#16: Eventually need some special claim types that 
        allow for the trusted-claims model
        to unfold.)</t>

        <t>This specification does not define the formats of required-claims
        lists and claims documents. It may ultimately put minimum conformance
        requirements on requesters and AMs to handle particular claim formats
        defined in other specifications, as well as specifying requirements
        that claim formats seeking consideration for use in UMA must meet. One
        candidate specification for lightweight claims requests and responses
        is <xref target="Claims2.0">Claims2.0</xref>.</t>
      </section>
    </section>

    <!-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -->

    <section anchor="protecting-a-resource" title="Protecting a Resource">
      <t>In order for a host to be able to delegate authorization to an AM,
      the authorizing sser must introduce the host to the AM. A successful
      conclusion of this phase is denoted by the following results: <list
          style="symbols">
          <t>The host has received metadata about the AM, such as OAuth
          endpoints.</t>

          <t>The host has received an OAuth access token (known as the host
          access token) that represents the authorizing user's approval for
          the host to work with a given AM in protecting resources. This host
          access token is used when the host makes requests at the AM's
          protection API.</t>

          <t>The AM has acquired information about resource sets on the host
          it is supposed to protect on behalf of the User.</t>
        </list></t>

      <t>The following steps are performed by the user, host, and AM in order
      to successfully complete the first phase: <list style="numbers">
          <t>The host looks up the AM's metadata and learns about its API
          endpoints and supported formats.</t>

          <t>If the host has not yet obtained an OAuth client identifier and
          optional secret from the AM, it registers with the AM dynamically,
          for example via the UMA dynamic registration protocol (see <xref
          target="Dyn-Reg">Dyn-Reg</xref>).</t>

          <t>The host obtains a host access token from the AM with the
          authorizing user's consent, by following the OAuth 2.0 authorization
          code or SAML bearer token profile.</t>

          <t>The host optionally registers scopes with the AM that are
          intended to be protected (see <xref target="reg-api"></xref>).</t>
        </list></t>

      <section title="Host Looks Up AM Metadata">
        <t>The host needs to learn the OAuth- and UMA-related endpoints of the
        AM before they can begin interacting. The authorizing user might
        provide the AM's location to get the Host started in this process, for
        example by typing a URL into a web form field or clicking a button.
        Alternatively, the host might already be configured to work with a
        single AM without requiring any user input. The exact process is
        beyond the scope of this specification, and it is up to the host to
        choose a method to learn the AM's location.</t>

        <t>From the data provided, discovered, or configured, the host MUST
        retrieve the hostmeta document as described in Section 2 of <xref
        target="hostmeta">hostmeta</xref>. For example, if the user supplied
        "am.example.com" as the Authorization Manager's domain, the host
        creates the URL "https://am.example.com/.well-known/host-meta" and
        performs a GET request on it.</t>

        <section title="AM Endpoints">
          <t>The AM MUST provide a XRD 1.0 formatted document at the hostmeta
          location, documenting the following: <list style="symbols">
              <t>A set of OAuth 2.0 end-user authorization and token endpoints
              for the host to use</t>

              <t>A set of OAuth 2.0 end-user authorization and token endpoints
              for requesters to use</t>

              <t>A set of UMA protection API endpoints for the host to use</t>

              <t>At least one access token format the AM produces</t>

              <t>Any claims formats the AM supports</t>
            </list></t>

          <t>(Note that the method of endpoint discovery defined here is
          intended to be compatible with the ultimate dynamic discovery,
          registration, and binding solution proposed by the OAuth group. The
          UMA group has proposed a generic solution at <xref
          target="Dyn-Reg">Dyn-Reg</xref>, with which this discovery step is
          compatible.)</t>

          <t>Property type values for access token and claim format
          information: <list hangIndent="6" style="hanging">
              <t
              hangText="http://kantarainitiative.org/confluence/display/uma/token_formats"><vspace />
              REQUIRED (one or more). Access token format produced by this AM.
              Currently the only option is "artifact".</t>

              <t
              hangText="http://kantarainitiative.org/confluence/display/uma/claim_formats"><vspace />
              OPTIONAL (zero or more). Claim format supported by this AM.
              Options are (ISSUE#17: fill in. Need to say what claims format is supported).</t>
            </list></t>

          <t>Link relationship rel values for the endpoint URLs for the host:
          <list hangIndent="6" style="hanging">
              <t
              hangText="http://kantarainitiative.org/confluence/display/uma/host_user_uri"><vspace />REQUIRED.
              Available HTTP methods are as defined by OAuth for an end-user
              authorization endpoint. Supplies the endpoint the host should
              use to gather the consent of the authorizing user for a host-AM
              relationship.</t>

              <t
              hangText="http://kantarainitiative.org/confluence/display/uma/host_token_uri"><vspace />REQUIRED.
              Available HTTP methods are as defined by OAuth for a token
              issuance endpoint. Supplies the endpoint the host should use to
              ask for a host access token.</t>

              <t
              hangText="http://kantarainitiative.org/confluence/display/uma/host_registration_uri"><vspace />REQUIRED.
              Supports the POST HTTP method, accompanied by a host access
              token. Supplies the endpoint the host should use for registering
              information with the AM, such as descriptions of resource sets
              that are to be protected by this AM and requested scopes on
              behalf of requesters. The AM SHOULD require the use of a
              transport-layer security mechanism such as TLS when the host
              sends requests to the host registration endpoint.</t>

              <t
              hangText="http://kantarainitiative.org/confluence/display/uma/host_token_validation_uri"><vspace />OPTIONAL.
              Supports the POST HTTP method, accompanied by a host access
              token. Supplies the endpoint the host should use to request
              validation of access tokens presented to them by requesters in
              Step 3. This endpoint SHOULD require the use of a
              transport-layer security mechanism such as TLS.</t>
            </list></t>

          <t>Link relationship rel values for the endpoint URLs for the
          requester: <list hangIndent="6" style="hanging">
              <t
              hangText="http://kantarainitiative.org/confluence/display/uma/req_user_uri"><vspace />
              REQUIRED. Available HTTP methods are as defined by <xref
              target="OAuth2"></xref> for a user authorization URL. Supplies
              the user authorization URL requesters should use to gather the
              consent of the authorizing user for user delegation flows in
              synchronous person-to-service sharing scenarios. (See Section
              @@TODO for the definition of this UMA-specific client profile.)
              This endpoint SHOULD require the use of a transport-layer
              security mechanism such as TLS.</t>

              <t
              hangText="http://kantarainitiative.org/confluence/display/uma/req_token_uri"><vspace />
              REQUIRED. Available HTTP methods are as defined by <xref
              target="OAuth2"></xref> for a token issuance URL. Supplies the
              token URL requesters should use to ask for an access token in
              step 2. This endpoint SHOULD require the use of a
              transport-layer security mechanism such as TLS.</t>

              <t
              hangText="http://kantarainitiative.org/confluence/display/uma/req_authz_uri"><vspace />
              REQUIRED. Supplies the authroization URL requesters should use
              to ask for authorization to grant a scope. This endpoint SHOULD
              require the use of a transport-layer security mechanism such as
              TLS.</t>
            </list></t>
        </section>

        <section title="Example">
          <figure>
            <preamble>For example:</preamble>

            <artwork><![CDATA[
      
<!-- Applies to both hosts and requesters --> 
<Property 
  type="http://wguma.org/confluence/display/uma/token_formats">
  saml
</Property>
<Property 
  type="http://wguma.org/confluence/display/uma/claim_formats">
  json
</Property>

<!-- Host protection API -->
<Link
  rel="http://wguma.org/confluence/display/uma/host_token_uri"
  href="https://am.example.com/host/token_uri"></Link>
<Link
  rel="http://wguma.org/confluence/display/uma/host_user_uri"
  href="https://am.example.com/host/user_uri"></Link>
<Link rel="http://kantarainitiative.org/confluence/display/uma/host_registration_uri"
  href="https://am.example.com/host/resource_details_uri"></Link>
<Link
  rel="http://wguma.org/confluence/display/uma/host_token_validation_uri"
  href="https://am.example.com/host/token_validation_uri"></Link>

<!-- Requester token-getting endpoints --> 
<Link rel="http://wguma.org/confluence/display/uma/req_token_uri"
  href="https://am.example.com/requester/token_uri"></Link> 
<Link rel="http://wguma.org/confluence/display/uma/req_user_uri"
  href="https://am.example.com/requester/user_uri"></Link>
<Link rel="http://wguma.org/confluence/display/uma/req_authz_uri"
  href="https://am.example.com/requester/authz_uri"></Link>
       ]]></artwork>
          </figure>
        </section>
      </section>

      <section title="Host Registers with AM">
        <t>If the Host has not already obtained a client identifier and
        optional secret from this AM previously, in this step it MUST do so in
        order to engage in OAuth-based interactions with the AM. This should
        be preferably using the UMA dynamic registration protocol. (see <xref
        target="Dyn-Reg">Dyn-Reg</xref>).</t>
      </section>

      <section title="Host Obtains Host Access Token">
        <t>In this step, the Host acquires a host access token from the AM
        that represents the approval of the authorizing User for the Host to
        trust the AM for protecting resources belonging to the User.</t>

        <t>The Host MUST use the <xref target="OAuth2">OAuth2</xref>
        authorization code or SAML bearer token profile, utilizing the
        end-user authorization and token endpoints as appropriate. Here the
        host acts in the role of an OAuth client. The authorizing user acts in
        the role of an OAuth end-user resource owner. The AM, through the
        provided endpoint URLs, acts in the role of an OAuth authorization
        server.</t>

        <t>A succesful completion of this step is signfified by the Host
        possesing a host access token for use at the authorized AM.</t>
      </section>

      <section title="Host registers resources to be protected">
        <t>Once the Host has received a host access token (in the previous
        step), it MAY immediately (or at any time until user authorization is
        revoked) present the token at the AM's host_registration_uri endpoint
        in order to register resources which the AM needs to protect. This is
        done in the manner defined in [[draft-uma-resource-reg]].</t>

        <t>Note that the Host is free to offer the option to protect any
        subset of the user's resources using different AMs or other means
        entirely, or to protect some resources and not others; any such
        partitioning by the host or user is outside the scope of this
        specification.</t>
        
        <section anchor="action-desc" title="Action Descriptions">
          <t>The host defines an action that is available for use with resources
            it manages in an action description encoded in <xref format="default"
              target="RFC4627">JSON</xref> form and made publicly accessible through a
            URI reference (it MAY include a fragment identifier). The actions
            available for use at any one host MUST have unique URI references so
            that the host's action descriptions are distinguishable by URI
            reference. Action descriptions MAY reside anywhere; the host is not
            required to self-host action descriptions and may wish to point to
            standardized action descriptions residing elsewhere.</t>
          
          <t>An action description is an object with the name "action" and with
            the following parameters:<list style="hanging">
              <t hangText="_id">REQUIRED. A string that uniquely identifies the
                action across all actions available at this host.</t>
              
              <t hangText="name">REQUIRED. A human-readable string describing the
                action. The AM SHOULD use the name in its user interface to assist
                the user in mapping authorization constraints to resource sets with
                this permissible action.</t>
              
              <t hangText="icon_uri">OPTIONAL. A URI for a graphic icon
                representing the action. If this is provided, the AM SHOULD use the
                referenced icon in its user interface to assist the user in mapping
                authorization constraints to resource sets with this permissible
                action.</t>
            </list></t>
          
          <figure>
            <preamble>For example, this description characterizes an action that
              involves reading or viewing resources (vs. creating them or editing
              them in some fashion):</preamble>
            
            <artwork><![CDATA[{
        "action":
            {
            "_id": "view"
            "name": "Read-only",
            "icon_uri": "http://www.example.com/icons/reading-glasses"
        }
}]]></artwork>
          </figure>
          
          <t>Action descriptions MAY contain extension parameters that are not
            defined in this specification. The names of extension parameters MUST
            begin with "x-" or "X-".</t>
        </section>
        
        <section anchor="resource-set-desc" title="Resource Set Descriptions">
          <t>The host defines a resource set that needs UMA protection in a
            resource set description encoded in <xref format="default"
              target="RFC4627">JSON</xref> form. The host registers the description
            and manages its lifecycle at the AM through the resource registration
            API.</t>
          
          <t>A resource set description is an object with the name "resource_set"
            and with the following parameters:<list style="hanging">
              <t hangText="_id">REQUIRED. A string that uniquely identifies the
                resource set. The resource set identifier has meaning only to the
                host, except insofar as the AM is able to map this resource set
                description to a particular user by virtue of the particular host
                access token used to access the resource registration API. The host
                MAY use any identifier scheme to represent resource sets, for
                example, making its identifiers unique across all users of this host
                or allowing for the sharing of resource set identifiers among users.
                However, for privacy reasons, it is RECOMMENDED that the host assign
                an identifier that is obscured with respect to any human-readable
                resource set label used at this host. Further, this identifier MUST
                match the resource set identifier path component of the URI used to
                manage this description in the resource registration API; see <xref
                  target="reg-api"></xref> for more information. (Typically this
                matching is achieved through automatically populating the parameter
                value on initial registration of the description.)</t>
              
              <t hangText="name">REQUIRED. A human-readable string describing a
                set of one or more resources. The AM SHOULD use the name in its user
                interface to assist the user in mapping authorization constraints to
                this resource set.</t>
              
              <t hangText="icon_uri">OPTIONAL. A URI for a graphic icon
                representing the resource set. If provided, the AM SHOULD use the
                referenced icon in its user interface to assist the user in mapping
                authorization constraints to this resource set.</t>
              
              <t hangText="actions">REQUIRED. An array referencing one or more
                identifiers of actions that are permissible on this resource set.
                Each action identifier MUST correspond to an action registered by
                this host for this user at this AM.</t>
            </list></t>
          
          <figure>
            <preamble>For example, this description characterizes a resource set
              (a photo album) that can potentially be only viewed, or alternatively
              to which full access can be granted; the URIs point to action
              descriptions, as dictated in <xref
                target="action-desc"></xref>:</preamble>
            
            <artwork><![CDATA[{
        "resource_set":
            {
            "_id":  "112210f47de98100",
            "name": "Photo album",
            "icon_uri": "http://www.example.com/icons/flower",
            "actions":
                        ["http://photoz.example.com/dev/actions/view",
                        "http://photoz.example.com/dev/actions/all"]
        }
}]]></artwork>
          </figure>
          
          <t>Resource set descriptions descriptions MAY contain extension
            parameters that are not defined in this specification. The names of
            extension parameters MUST begin with "x-" or "X-".</t>
          
          <t>When a host creates or updates a resource set description (see <xref
            target="reg-api"></xref>), the AM MUST attempt to retrieve the
            referenced action descriptions. It MAY cache such descriptions as long
            as indicated in the HTTP header for the action description resource
            unless the resource set description is subsequently updated within the
            validity period. At the beginning of an authorizing user's login session
            at the AM, the AM MUST attempt to re-retrieve action descriptions
            applying to that user whose cached versions have expired.</t>
        </section>
        
      </section>
    </section>

    <section anchor="reg-api" title="Resource Registration API">
      <t>The host uses a RESTful API at the AM's host_registration_uri to
      create, read, update, and delete resource set descriptions, along with
      listing groups of such descriptions. The host MUST use its valid host
      access token obtained previously in UMA protocol step 1 to gain access
      to the API.</t>

      <t>Individual resource set descriptions are managed at URIs with this
      structure: "{reguri}/host/{hostid}/resource_set/{resourcesetid}"</t>

      <t>The components of these URIs are defined as follows:<list
          style="hanging">
          <t hangText="{reguri}">The AM's host_registration_uri as advertised
          in its metadata. This endpoint, its security requirements, and its
          requirements around advertisement in metadata are defined in UMA
          protocol step 1.</t>

          <t hangText="{hostid}">A registration area at the AM that is
          specific to this host. The host MUST use the OAuth client identifier
          it was assigned by this AM as its host identifier. If the host
          identifier does not match the host access token used at the host
          registration endpoint, the AM MUST report an HTTP 403 Forbidden
          error (see example below) and fail to act on the request.</t>

          <t hangText="{resourcesetid}">An identifier for a resource set
          description. The identifier MUST match the "_id" parameter value in
          the description itself.</t>
        </list></t>

      <t>Without a specific resource identifier path component, the URI
      applies to the set of resource set descriptions already registered.</t>

      <t>Following is a summary of the five registration API operations the AM
      is REQUIRED to support. Each is defined in its own section below. All
      other methods are unsupported.<list style="symbols">
          <t>Create resource set description: PUT
          /host/{hostid}/resource_set/{resourcesetid}</t>

          <t>Read resource set description: GET
          /host/{hostid}/resource_set/{resourcesetid}</t>

          <t>Update resource set description: PUT
          /host/{hostid}/resource_set/{resourcesetid}</t>

          <t>Delete resource set description: DELETE
          /host/{hostid}/resource_set/{resourcesetid}</t>

          <t>List resource set descriptions: GET
          /host/{hostid}/resource_set/</t>
        </list></t>

      <t>The AM MUST respond to host requests using unsupported HTTP methods
      with an HTTP 403 Forbidden error and MUST fail to act on the
      request.</t>

      <figure>
        <preamble>HTTP response (unsupported method or host ID not matching
        the presented host access token):</preamble>

        <artwork><![CDATA[HTTP/1.1 403 Forbidden
...

(Body provides user-readable explanation of the error.)]]></artwork>
      </figure>

      <section anchor="create-resource-set"
               title="Create Resource Set Description">
        <t>Adds a new resource set description using the PUT method. The host
        assigns a unique identifier to the action. The host is free to use its
        own methods of identifying and describing resource sets; the AM MUST
        treat them as opaque for the purpose of authorizing access, other than
        associating them with the authorizing user represented by the host
        access token used to access the API. On successfully registering a
        resource set, the host MUST use UMA mechanisms to limit access to any
        resources corresponding to this resource set.</t>

        <figure>
          <preamble>HTTP request:</preamble>

          <artwork><![CDATA[PUT /host/{hostid}/resource/{resourceid}
Content-Type: application/json
...

(Body contains JSON representation of resource set description to be created.)]]></artwork>
        </figure>

        <figure>
          <preamble>HTTP response (success):</preamble>

          <artwork><![CDATA[HTTP/1.1 201 Created
Content-Type: application/json
Location: (URL of the created resource, same as that which was PUT.)
...]]></artwork>
        </figure>
      </section>

      <section anchor="read-resource-set"
               title="Read Resource Set Description">
        <t>Reads a previously registered resource set description using the
        GET method.</t>

        <figure>
          <preamble>HTTP request:</preamble>

          <artwork><![CDATA[GET /host/{hostid}/resource/{resourceid} HTTP/1.1
...]]></artwork>
        </figure>

        <figure>
          <preamble>HTTP response (success):</preamble>

          <artwork><![CDATA[HTTP/1.1 200 OK
Content-Type: application/json
ETag: (entity tag of the resource artifact)
...

(Body contains JSON representation of the resource set description.)]]></artwork>
        </figure>

        <figure>
          <preamble>HTTP response (not found):</preamble>

          <artwork><![CDATA[HTTP/1.1 404 Not Found
...

(Body provides user-readable explanation of the error.)]]></artwork>
        </figure>
      </section>

      <section anchor="update-resource-set"
               title="Update Resource Set Description">
        <t>Updates a previously registered resource set description using the
        PUT method.</t>
        
        <t>This API is different from the create new resource set description
          (<xref target="create-resource-set"></xref>) because it assumes
          that prior registration of the resource has occured.</t>
        
        <t>(ISSUE#27: Can Update Resource Set Description API 
          mistakenly overwrite/destroy an existing
        resource description?).</t>

        <figure>
          <preamble>HTTP request:</preamble>

          <artwork><![CDATA[PUT /host/{hostid}/resource/{resourceid}
Content-Type: application/json
If-Match: (entity tag of the resource if operation is to be idempotent)
...

(Body contains JSON representation of resource set description to be updated.)]]></artwork>
        </figure>

        <figure>
          <preamble>HTTP response (success):</preamble>

          <artwork><![CDATA[HTTP/1.1 204 No Content
...]]></artwork>
        </figure>

        <figure>
          <preamble>HTTP response (entity tag does not match):</preamble>

          <artwork><![CDATA[HTTP/1.1 412 Precondition failed
...]]></artwork>
        </figure>
      </section>

      <section anchor="delete-resource-set"
               title="Delete Resource Set Description">
        <t>Deletes a previously registered resource set description using the
        DELETE method.</t>

        <figure>
          <preamble>HTTP request:</preamble>

          <artwork><![CDATA[DELETE /host/{hostid}/resource/{resourceid}
If-Match: (entity tag of the resource if operation to be idempotent)
...]]></artwork>
        </figure>

        <figure>
          <preamble>HTTP response (success):</preamble>

          <artwork><![CDATA[HTTP/1.1 204 No content
...]]></artwork>
        </figure>

        <figure>
          <preamble>HTTP response (not found):</preamble>

          <artwork><![CDATA[HTTP/1.1 404 Not Found
...

(Body provides user-readable explanation of the error.)]]></artwork>
        </figure>

        <figure>
          <preamble>HTTP response (entity tag does not match):</preamble>

          <artwork><![CDATA[HTTP/1.1 412 Precondition failed
...]]></artwork>
        </figure>
      </section>



      <section anchor="list-resource-sets"
               title="List Resource Set Descriptions">
        <t>Lists all previously registered resource set identifiers for this
        user using the GET method. The list is in the form of a JSON array of
        {resourcesetid} values.</t>

        <figure>
          <preamble>HTTP request:</preamble>

          <artwork><![CDATA[GET /host/{hostid}/resource_set/
...]]></artwork>
        </figure>

        <figure>
          <preamble>HTTP response:</preamble>

          <artwork><![CDATA[HTTP/1.1 200 OK
Content-Type: application/json
...

(Body contains JSON array of {resourcesetid} values.)]]></artwork>
        </figure>
      </section>
      
      <section anchor="list-resource-sets-example" title="Example">
          <t>The following example illustrates the intent and usage of the
            resource registration protocol.</t>
          
          <t>This example contains some steps that are exclusively in the realm of
            user experience rather than web protocol, to achieve realistic
            illustration; these steps are labeled "User experience only". Some other
            steps are exclusively internal to the operation of the entity being
            discussed; these are labeled "Internal only".</t>
          
          <t>An authorizing user, Alice Adams, has just uploaded a photo of her
            new puppy to a host, Photoz.example.com, and wants to ensure that this
            specific photo is not publicly accessible.</t>
          
          <t>Alice has already introduced this host to her AM,
            CopMonkey.example.com, and thus Photoz has already obtained an OAuth
            client ID and an UMA host access token from CopMonkey. However, Alice
            has not previously instructed Photoz to use CopMonkey to protect any
            other photos of hers.</t>
          
          <t>Alice has previously visited CopMonkey to map a default "do not share
            with anyone" authorization constraint to any resource sets registered by
            Photoz, until such time as she maps some other less-draconian
            constraints to those resources. (User experience only. This may have
            been done at the time Alice introduced the host to the AM, and/or it
            could have been a global or host-specific preference setting. A
            different constraint or no constraint at all might be associated with
            newly protected resources.) Other kinds of constraints she may
            eventually map to particular photos or albums might be "Share only with
            husband@email.example.net" or "Share only with people in my 'family'
            group".</t>
          
          <t>Photoz itself has a publicly documented API that offers two dozen
            different methods that apply to single photos, such as "addTags" and
            "getSizes", but rolls them up into two photo-related actions: "viewing"
            (consisting of varous read-only operations) and "all" (consisting of
            various reading, editing, and printing operations). It defines two
            Web-accessible JSON-encoded documents called action descriptions that
            represent these actions, which it is able to reuse for all of its users
            (not just Alice). The "name" parameter values are intended to be seen by
            Alice when she maps authorization constraints to specific resource sets
            and actions while visiting CopMonkey, such that Alice would see the
            strings "View Photo and Related Info" and "All Actions", likely
            accompanied by the referenced icons, in the CopMonkey interface. (Other
            users of Photoz might similarly see the same labels at CopMonkey or
            whatever other AM they use.)</t>
          
          <figure>
            <artwork><![CDATA[{
        "action":
            {
            "_id": "view"
            "name": "View Photo and Related Info",
            "icon_uri": "http://www.example.com/icons/reading-glasses"
        }
}]]></artwork>
          </figure>
          
          <figure>
            <artwork><![CDATA[{
        "action":
            {
            "_id": "all"
            "name": "All Actions",
            "icon_uri": "http://www.example.com/icons/galaxy"
        }
}]]></artwork>
          </figure>
          
          <t>While visiting Photoz, Alice selects a link or button that instructs
            the site to "Protect" or "Share" this single photo (user experience
            only; Photoz could have made this a default or preference setting).</t>
          
          <t>As a result, Photoz defines for itself a resource set that represents
            this photo (internal only; Photoz is the only application that knows how
            to map a particular photo to a particular resource set). Photoz also
            prepares the following resource set description, which is specific to
            Alice and her photo. The "name" parameter value is intended to be seen
            by Alice in mapping authorization constraints to specific resource sets
            and actions when she visits CopMonkey, such that Alice would see the
            string "Steve the puppy!", likely accompanied by the referenced icon, in
            the CopMonkey interface. The possible actions on this resource set are
            indicated with URI references to the action descriptions, as defined
            just above.</t>
          
          <figure>
            <artwork><![CDATA[{
        "resource_set":
            {
            "_id": "112210f47de98100"
            "name": "Steve the puppy!",
            "icon_uri": "http://www.example.com/icons/flower",
            "actions":
                        ["http://photoz.example.com/dev/actions/view",
                        "http://photoz.example.com/dev/actions/all"]
        }
}]]></artwork>
          </figure>
          
          <t>Photoz uses the "create resource set description" method of
            CopMonkey's standard UMA-based resource registration API, presenting its
            Alice-specific host access token there, to register and assign an
            identifier to the resource set description. The resource set identifier
            path component of the URL matches the "_id" parameter value in the
            description.</t>
          
          <figure>
            <artwork><![CDATA[PUT /host/photoz.example.com/resource/112210f47de98100
Content-Type: application/json
...

{
        "resource_set":
           {
           "_id": "112210f47de98100"
           "name": "Steve the puppy!",
           "icon_uri": "http://www.example.com/icons/flower",
           "actions":
                        ["http://photoz.example.com/dev/actions/view",
                        "http://photoz.example.com/dev/actions/all"]
         }
}]]></artwork>
          </figure>
          
          <t>Once this description has been successfully registered, Photoz is
            responsible for responding to requesters' attempts to access this photo,
            achieving protection of the resource by "outsourcing" this task to
            CopMonkey.</t>
          
          <t>At the time Alice indicates she would like this photo protected,
            Photoz can choose to redirect Alice to CopMonkey for further
            authorization constraint mapping, access auditing, and other AM-related
            tasks (user experience only).</t>
          
          <t>Over time, as Alice uploads other photos and creates and organizes
            photo albums, and as Photoz makes new action functionality available,
            Photoz can use additional methods of the resource registration API to
            ensure that CopMonkey's understanding of Alice's protected resources
            matches its own.</t>
      </section>
      
    </section>




    <!-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -->

    <section title="Error Messages">
      <t>Ultimately the host is responsible for either granting the access the
      requester attempted, or returning an error response to the requester
      with a reason for the failure. <xref target="OAuth2"></xref> defines
      several error responses for a resource server to return. UMA makes use
      of these error responses, but requires the host to "outsource" the
      determination of some error conditions to the AM.</t>

      <t>The host is responsible for determining "insufficient_scope". If the
      requester's attempted access does not match any of the scopes returned
      by the AM in its valid-token response to the host, the host returns an
      "insufficient_scope" error to the requester.</t>

      <t>The host is responsible for determining "invalid_request". If the
      requester's request was badly formed, the host returns an
      "invalid_request" error to the requester.</t>

      <t>If the AM determined that the requester access token is invalid, it
      returns an "invalid_requester_token" error response to the host. [@@TBS:
      Need to flesh out more and provide an example.] The host then returns an
      "invalid_token" response to the requester as described in section 5.2.1
      of <xref target="OAuth2"></xref>.</t>

      <t>If the AM determined that the requester access token has expired, it
      returns an "expired_requester_token" error response to the host. [@@TBS:
      Need to flesh out more and provide an example.] The host then returns an
      "invalid_token" response to the requester as described in section 5.2.1
      of <xref target="OAuth2"></xref>.</t>

      <t>If the host's token validation request message itself was badly
      formed, the AM returns an "invalid_request" error to the host. [@@Need
      to say what happens to the requester after that?]</t>

      <section anchor="am-error-response" title="AM endpoints error responses">
        <t>If the client request to the Authorization Manager endpoint is invalid,
        the Authorization Manager constructs the error response by adding the
        following parameters to the entity body of the HTTP response using the
        "application/json" media type:

        <list style="hanging">
            <t hangText="error">REQUIRED. A single error code. Value for this
            parameter is defined in the specific AM endpoint description</t>
            <t hangText="error_description">OPTIONAL. A human-readable text providing
            additional information, used to assist in the understanding and resolution
            of the error occurred.</t>
            <t hangText="error_uri">OPTIONAL. A URI identifying a human-readable web
            page with information about the error, used to provide the end-user with
            additional information about the error.</t>
        </list></t>

        <t>Common error codes:</t>
        <t hangText="invalid_request"> The request is missing a required parameter or
        is otherwise malformed.  The AM MUST respond with the HTTP 400 (Bad Request)
        status code.</t>

        <t>For example:</t>
        <figure>
          <artwork><![CDATA[
          HTTP/1.1 400 Bad Request
          Content-Type: application/json
          Cache-Control: no-store
          {
              {
                  "error":"invalid_request",
                  "error_description":"There is already a resource with this identifier.",
                  "error_uri":"http://am.example.com/errors/resource_exists"
              }
          }]]></artwork>
        </figure>
      </section>

    </section>

    <!-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -->

    <section title="Security Considerations">
      <t>All drafts are required to have a security considerations section.
      See <xref target="RFC3552">RFC 3552</xref> for a guide.</t>

      <t>This specification relies mainly on OAuth security mechanisms for
      protecting the host registration endpoint at the AM so that only a
      properly authorized host can access it on behalf of the intended user.
      For example, the host needs to use a valid host access token issued
      through a user authorization process at the endpoint, and the
      interaction should take place over TLS. It is expected that the host
      will protect its client secret (if it was issued one) and will protect
      its host access token, particularly if used in "bearer token"
      fashion.</t>

      <t>In addition, this specification dictates a binding between the host
      access token and the host-specific registration area on the AM to
      prevent a host from interacting with a registration area not its
      own.</t>

      <t>(ISSUE#18: Other stuff goes here too. Provide commentary on any
      requirements layered on the forthcoming OAuth security considerations
      section; discuss UMA-layer implications for more meaningful
      authentication of requesters/requesting parties; discuss implications of
      user-mediated AM/host trust model; discuss short-lived token technique
      for lightweight requester correlation...)</t>
    </section>

    <section title="Privacy Considerations">
      <t>The AM comes to be in possession of resource set information (such as
      names and icons) that may reveal information about the user, which the
      AM's trust relationship with the host is assumed to accommodate.
      However, the requester is a less-trusted party (in fact, entirely
      untrustworthy until it acquires a requester access token in UMA protocol
      step 2). This specification recommends obscuring resource set
      identifiers in order to avoid leaking personally identifiable
      information to requesters through the "scope" mechanism.</t>

      <t>(ISSUE#19: Other stuff goes here too. More privacy considerations.)</t>
    </section>

    <!-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -->

    <section title="Conformance">
      <t>This section outlines conformance requirements for various entities
      implementing UMA endpoints. Currently two levels of conformance are
      defined: minimal and full. (Other types or levels may ultimately be
      defined in this specification or in other specifications that profile or
      extend this one.)</t>

      <t>This specification has dependencies on other specifications, as
      follows:<list style="symbols">
          <t>OAuth 2.0: AMs, hosts, and requesters MUST support OAuth 2.0
          features named in this specification for minimal conformance. For
          example, features related to refresh tokens, client secrets, and the
          web server profile are mentioned and support for them is
          REQUIRED.</t>

          <t>Dynamic registration: For full conformance, AMs MUST support
          dynamic registration. For minimal conformance, AMs are not required
          to support dynamic registration. Hosts need not support the
          requesting of dynamic registration at either conformance level.</t>

          <t>Resource registration: For minimal conformance, AMs and hosts
          MUST support resource registration.</t>
        </list></t>
    </section>

    <!-- Possibly a 'Contributors' section ... -->

    <section anchor="IANA" title="IANA Considerations">
      <t>TBD</t>
    </section>

    <section anchor="Acknowledgments" title="Acknowledgments">
      <t>List of UMA contributors</t>
    </section>

    <section title="Issues">
      <t>Catalog of issues (some noted within the text above as well,
      indicated by "ISSUE"):<list style="numbers">
          <t>ISSUE#01: Need to specify options for claim formats in the XRD.</t>

        <t>ISSUE#02: Need to clarify how the requester's user authorization endpoint
          would be used in an UMA (vs. an OAuth) fashion for collecting
          synchronous authorizing user consent in Phase 2, based on a
          privileged type of claim request.</t>

        <t>ISSUE#03: Do we need to specify explicitly a means for the requester to get
          a new or refreshed access token from the AM, or can we mostly just
          refer to OAuth for this? Right now this interaction type doesn't
          have its own section.</t>

        <t>ISSUE#04: Need to specify the format of the token validation request
          message. Can Maciej supply what they're using?</t>

        <t>ISSUE#05: When the token is invalid, what's the current OAuth thinking on
          what we should return? Is there any reason not to copy OAuth as
          closely as possible in this case? Or should a token status of
          "invalid" be used, and returned as success (unifying the different
          kinds of responses to the validation request)?</t>

        <t>ISSUE#06: Need to complete the design of the requested-scope registration
          interaction and its associated error messages.</t>

        <t>ISSUE#07: Need to complete the design of the authorization request
          interaction and its associated error messages.</t>

        <t>ISSUE#08: Sort out whether resource set descriptions are supposed to use
          scope URIs or scope identifiers! It's inconsistent now.</t>

        <t>ISSUE#09: Move the resource registration API section to be a subsection
          under the previous big section.</t>

        <t>ISSUE#10: Copy over the resource set description and scope description
          content.</t>
        
        <t>ISSUE#11:Refer to OAuth processes for getting a token
          "autonomously" here? Currently there is no section for the
          requester-AM token-getting interaction. 
          RESOLUTION#11: a new section has been added, to discuss
          about the usage of OAuth flow for the requester 
          to gen a token from the AM.</t>
        
        <t>ISSUE#12:  If the the AM finds the requester's access token to be invalid,
          it returns an UMA error message (ISSUE#12: correct? HTTP success?) to
          indicate that the requester's token is invalid.</t>
        
        <t>ISSUE#13: How to structure the body to
        include the scope and also the requester's access token?</t>
        
        <t>ISSUE#14: Need to unify the request for
        authorization with the providing of claims, so that this can be a
        single request-response pattern that can loop as required.</t>
        
        <t>ISSUE#15: If the content-type (of the claims response document)
        is not recognized by the AM, what happens then? 
        Should be an error from the AM.</t>
        
        <t>ISSUE#16: Eventually need some special claim types that 
        allow for the trusted-claims model to unfold.</t>
        
        <t>ISSUE#17: fill in. Need to say what claims format is supported.</t>
        
        <t>ISSUE#18: Provide commentary on any
          requirements layered on the forthcoming OAuth security considerations
          section; discuss UMA-layer implications for more meaningful
          authentication of requesters/requesting parties; discuss implications of
          user-mediated AM/host trust model; discuss short-lived token technique
          for lightweight requester correlation...</t>
        
        <t>ISSUE#19: Other stuff goes here too. More privacy considerations.</t>
        
        <t>ISSUE#20: From Lukasz email 6/6/2011: 
          Rev8 Section 2.2: +1 for validation request in json format 
          instead of application/x-www-form-urlencoded. </t>
        
        <t>ISSUE#21: From Lukasz email 6/6/2011: 
          Rev8 Section 2.4: AM adds a scope to the requester's access token. 
          Maybe I am missing something but I don't see the explanation in the 
          spec how requester's token is issued at first. 
          I think some parts are mutual for the host and the requester 
          i.e. AM Discovery, optional Dynamic Client Registration.  </t>
        
        <t>ISSUE#22: From Lukasz email 6/6/2011: 
          Rev8 Section 3.4.2: Example is missing required '_id' parameter.  
          ACTION#22: '_id' parameter added.</t>
        
        <t>ISSUE#23: From Lukasz email 6/6/2011: 
          Rev8 Section 4: 403 Forbidden response when: 'unsupported method or host ID 
          not matching the presented host access token'. 
          I think AM should return 403 in case of performing operations on 
          resources of different user (not owned resources at this same host), 
          instead of returning 404 Not Found to not disclose 
          presence of the resource set at the AM. </t>
        
        <t>ISSUE#24: From Lukasz email 6/6/2011: 
          Rev8 Section 4.1: Empty response body? 
          In SAM we return 'resource_id' and 'policy_uri' 
          so that the host can redirect the user to 
          the policy definition page (sharing setting screen) on AM. </t>
        
        <t>ISSUE#25: From Lukasz email 6/6/2011: 
        Section 4.1 - what happens when a resource (being registered) already exists?</t>
        
        <t>ISSUE#26: From Lukasz email 6/6/2011: 
          Section 4.1 to 4.4: URLs in the examples mistakenly contains '/user/{userid}'.
          ACTION#26: examples have been corrected.</t>
        
        <t>ISSUE#27: Can Update Resource Set Description API 
          mistakenly overwrite/destroy an existing
          resource description?.  (<xref target="update-resource-set"></xref>)
        </t>
        
        </list></t>
    </section>
  </middle>

  <!--  *****BACK MATTER ***** -->

  <back>
    <references title="Normative References">
      <?rfc include='http://xml.resource.org/public/rfc/bibxml/reference.RFC.2617.xml' ?>

      <?rfc include='http://xml.resource.org/public/rfc/bibxml/reference.RFC.2119.xml' ?>

      <?rfc include='http://xml.resource.org/public/rfc/bibxml/reference.RFC.5785.xml' ?>

      <?rfc include='http://xml.resource.org/public/rfc/bibxml3/reference.I-D.draft-hammer-hostmeta-13.xml'?>

      <?rfc include='http://xml.resource.org/public/rfc/bibxml3/reference.I-D.draft-ietf-httpbis-p1-messaging-09.xml'?>

      <reference anchor="OAuth2"
                 target="http://tools.ietf.org/html/draft-ietf-oauth-v2-16">
        <front>
          <title>The OAuth 2.0 Protocol</title>

          <author initials="E." surname="Hammer-Lahav">
            <organization>IETF</organization>
          </author>

          <date year="2010" />
        </front>
      </reference>

      <reference anchor="Dyn-Reg"
                 target="http://tools.ietf.org/html/draft-hardjono-oauth-dynreg-00.html">
        <front>
          <title>OAuth Dynamic Client Registration Protocol</title>

          <author initials="C." surname="Scholz">
            <organization>IETF</organization>
          </author>

          <date year="2010" />
        </front>
      </reference>

      <reference anchor="hostmeta"
                 target="http://xml.resource.org/public/rfc/bibxml3/reference.I-D.draft-hammer-hostmeta-13.xml">
        <front>
          <title>Web Host Metadata</title>

          <author initials="E." surname="Hammer-Lahav">
            <organization>Yahoo!</organization>
          </author>

          <date year="2010" />
        </front>
      </reference>

      <reference anchor="Claims2.0"
                 target="http://wguma.org/confluence/display/uma/Claims+2.0">
        <front>
          <title>Claims 2.0</title>

          <author initials="E." surname="Maler">
            <organization>Kantara</organization>
          </author>

          <date year="2010" />
        </front>
      </reference>

      <reference anchor="ID-ietf-httpbis-p1-messaging"
                 target="http://tools.ietf.org/html/draft-ietf-httpbis-p1-messaging-14">
        <front>
          <title>http://tools.ietf.org/html/draft-ietf-httpbis-p1-messaging-14</title>

          <author initials="R." surname="Fielding">
            <organization>IETF</organization>
          </author>

          <date year="2011" />
        </front>
      </reference>
    </references>

    <references title="Informative References">
      <!-- Here we use entities that we defined at the beginning. -->

      &RFC3552;
      &RFC4627;
    </references>

    <section anchor="History" title="Document History">
      <t>NOTE: To be removed by RFC editor before publication as an RFC</t>
      
      
      <t>Changes in Rev 9:<list style="symbols">
        <t>Added new top-level section on Requester obtaining
        an acces token from the AM.</t>
      </list></t>
        
        
      <t>Changes in Rev 8:<list style="symbols">
        <t>Added sections on Action Descriptions and Resource Set Descriptions.
        Text obtained from the Resource Registration doc, which is being
        discontinued.</t>
      </list></t>

      <t>Changes in Rev 7:<list style="symbols">
          <t>Reintroduced three-phase language, but removed overt mention of
          it in the sections after the introduction.</t>

          <t>Added new requester authorization endpoint for use in Phase
          2.</t>

          <t>Moved the Phase 1 content after the Phases 2/3 content because
          requesters don't need to read it.</t>

          <t>Moved the important resource registration spec content to the
          core spec.</t>

          <t>Changed the old "action" language to "scope" language
          throughout.</t>
        </list></t>

      <t>Changes in Rev 6: <list style="symbols">
          <t>Now only using two phases.</t>

          <t>Merged Phase III into Phase II, and removed duplication of
          steps.</t>

          <t>Revised the Introduction section.</t>

          <t>Introduced examples section (TBD).</t>
        </list></t>

      <t>Changes in Rev 5: <list style="symbols">
          <t>Placed Etherpad items into Section 3.</t>

          <t>Used Phases (instead of stepa and substeps).</t>
        </list></t>
    </section>
  </back>
</rfc>
